---
title: "SpaGene"
author: "Jin Huhao"
date: "2024-04-09"
output:
  pdf_document: default
  html_document: default
---

```{r}
library(Seurat)
library(SeuratDisk)
library(spacexr)
library(Matrix)
library(dplyr)
library(ggplot2)
library(SpaGene)
library(pheatmap)
library(gridExtra)
```

```{r}
path <- "D:/Desktop/MGI/CODE/"

# Data
data <- LoadH5Seurat(paste0(path, "Data/SS200000116BR_E6.bin200.h5seurat"))
head(data@meta.data, 5)
```

```{r}
coords <- data@meta.data %>% select(x, y)
coords
```

```{r}
counts = GetAssayData(data)
counts
```
```{r}
# Identify spatial variable genes based on spatial connectness of spots with high expression

# expr: gene expression matrix, the row is the gene and the column is the spot/cell
# location: location matrix, the row number of location should match the column number of expr
# normalize: default True

spa_gene <- SpaGene(expr = counts, location = coords)
```

```{r}
head(spa_gene$spagene_res[order(spa_gene$spagene_res$adjp),])
```

```{r}
pattern<-FindPattern(spa_gene)
```
```{r}
pattern_plots <- PlotPattern(pattern, coords)
```

```{r}
pattern_plots
```


```{r}
pattern_plots[[1]]
```

```{r}
top5<-apply(pattern$genepattern, 2, function(x){names(x)[order(x,decreasing=T)][1:5]})
top5
```
```{r}
pheatmap(pattern$genepattern[rownames(pattern$genepattern)%in%top5,])
```

```{r}
top5_in_pattern1 <- top5[, "Pattern1"]
top5_in_pattern1
```

```{r}
top5_df <- counts[top5_in_pattern1, ] %>% as.matrix() %>% t() %>% as.data.frame() 
top5_df
```
```{r}
top5_df <- cbind(top5_df, coords)
top5_df
```

```{r}
plots <- lapply(1:5, function(i) {

  cell_data <- top5_df[, c(i, 6, 7)]
  colnames(cell_data) <- c("Expression", "X", "Y")
  
  p <- ggplot(cell_data, aes(x = X, y = Y, color = Expression)) +
    geom_point(size = 1) +
    scale_color_gradient(low = "white", high = "red", limits = range(top5_df[,1:5])) +  
    labs(title = colnames(top5_df)[i])  
  
  return(p)
})

plots[[1]]
plots[[2]]
plots[[3]]
plots[[4]]
plots[[5]]
```









